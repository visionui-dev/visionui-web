<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cuenta - VisionUI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="../vui.ico">
    <style>
        :root {
            --bg-primary: #0f0f13;
            --bg-secondary: #16161d;
            --bg-card: #1c1c26;
            --text-primary: #f5f5f7;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent: #7c3aed;
            --accent-light: #a78bfa;
            --success: #10b981;
            --success-bg: rgba(16, 185, 129, 0.1);
            --error: #ef4444;
            --error-bg: rgba(239, 68, 68, 0.1);
            --warning: #f59e0b;
            --border: #27272a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .auth-box { max-width: 420px; width: 100%; }

        .auth-header { text-align: center; margin-bottom: 2rem; }

        .logo {
            width: 56px; height: 56px;
            background: linear-gradient(135deg, var(--accent), #ec4899);
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 1.25rem;
            font-size: 1.75rem;
        }

        .auth-header h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .auth-header p { color: var(--text-secondary); font-size: 0.95rem; }

        .auth-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 4px;
        }

        .auth-tab {
            flex: 1; padding: 0.75rem;
            text-align: center;
            background: none; border: none;
            color: var(--text-muted);
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .auth-tab.active { background: var(--accent); color: white; }
        .auth-tab:hover:not(.active) { color: var(--text-primary); }

        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; }

        .form-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus { outline: none; border-color: var(--accent); }

        .btn {
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            width: 100%; padding: 1rem;
            border-radius: 8px;
            font-weight: 600; font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-decoration: none;
        }

        .btn-primary { background: linear-gradient(135deg, var(--accent), #ec4899); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(124, 58, 237, 0.3); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: none; font-size: 0.9rem; }
        .alert.show { display: block; }
        .alert-error { background: var(--error-bg); border: 1px solid var(--error); color: #fca5a5; }
        .alert-success { background: var(--success-bg); border: 1px solid var(--success); color: #6ee7b7; }

        .auth-footer { text-align: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }
        .auth-footer a { color: var(--accent-light); text-decoration: none; font-size: 0.9rem; }
        .auth-footer a:hover { text-decoration: underline; }

        .dashboard-container { max-width: 900px; margin: 0 auto; padding: 2rem; }

        .dashboard-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem; padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap; gap: 1rem;
        }

        .user-info { display: flex; align-items: center; gap: 1rem; }

        .user-avatar {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, var(--accent), #ec4899);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.25rem; color: white;
        }

        .user-details h2 { font-size: 1.1rem; margin-bottom: 0.125rem; }
        .user-details p { color: var(--text-muted); font-size: 0.85rem; }

        .logout-btn {
            padding: 0.625rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover { border-color: var(--error); color: var(--error); }

        .section { margin-bottom: 2rem; }
        .section-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }

        .license-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .license-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .license-app { font-size: 1.1rem; font-weight: 600; }

        .license-status { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .license-status.active { background: var(--success-bg); color: var(--success); }
        .license-status.expired { background: var(--error-bg); color: var(--error); }

        .license-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .license-detail { font-size: 0.85rem; }
        .license-detail-label { color: var(--text-muted); margin-bottom: 0.25rem; }
        .license-detail-value { font-family: monospace; color: var(--text-primary); word-break: break-all; }

        .license-actions { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }

        .download-btn {
            display: inline-flex; align-items: center; gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            background: var(--accent); color: white;
            border-radius: 6px;
            font-size: 0.875rem; font-weight: 500;
            text-decoration: none;
            transition: all 0.2s;
        }

        .download-btn:hover { background: #6d28d9; }

        .empty-state {
            text-align: center; padding: 3rem 2rem;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
        .empty-state p { color: var(--text-secondary); margin-bottom: 1.5rem; }

        .hidden { display: none !important; }

        .back-link {
            display: inline-flex; align-items: center; gap: 0.5rem;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .back-link:hover { color: var(--text-secondary); }

        .spinner { width: 24px; height: 24px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-overlay { position: fixed; inset: 0; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; z-index: 1000; }

        .promo-banner {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.2), rgba(236, 72, 153, 0.2));
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .promo-banner h3 { margin-bottom: 0.5rem; }
        .promo-banner p { color: var(--text-secondary); margin-bottom: 1rem; }

        @media (max-width: 640px) {
            .dashboard-header { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>

    <!-- Auth View -->
    <div class="auth-container hidden" id="authView">
        <div class="auth-box">
            <div class="auth-header">
                <div class="logo">‚ú®</div>
                <h1>Mi Cuenta</h1>
                <p>Inicia sesi√≥n o crea una cuenta</p>
            </div>

            <div class="auth-card">
                <div class="auth-tabs">
                    <button class="auth-tab active" id="tabLogin" onclick="switchTab('login')">Iniciar sesi√≥n</button>
                    <button class="auth-tab" id="tabRegister" onclick="switchTab('register')">Crear cuenta</button>
                </div>

                <div id="alertBox" class="alert"></div>
                
                <!-- Login Form -->
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required placeholder="tu@email.com" autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Contrase√±a</label>
                        <input type="password" id="loginPassword" required placeholder="Tu contrase√±a" autocomplete="current-password">
                    </div>
                    <button type="submit" class="btn btn-primary" id="loginBtn">Iniciar sesi√≥n</button>
                </form>

                <!-- Register Form -->
                <form id="registerForm" class="hidden" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label for="registerName">Nombre (opcional)</label>
                        <input type="text" id="registerName" placeholder="Tu nombre" autocomplete="name">
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" required placeholder="tu@email.com" autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Contrase√±a</label>
                        <input type="password" id="registerPassword" required placeholder="M√≠nimo 6 caracteres" autocomplete="new-password" minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="registerPassword2">Confirmar contrase√±a</label>
                        <input type="password" id="registerPassword2" required placeholder="Repite tu contrase√±a" autocomplete="new-password">
                    </div>
                    <button type="submit" class="btn btn-primary" id="registerBtn">Crear cuenta</button>
                </form>

                <div class="auth-footer">
                    <a href="store.html">Ver aplicaciones disponibles ‚Üí</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard View -->
    <div class="dashboard-container hidden" id="dashboardView">
        <a href="../index.html" class="back-link">‚Üê Volver al inicio</a>

        <div class="dashboard-header">
            <div class="user-info">
                <div class="user-avatar">üë§</div>
                <div class="user-details">
                    <h2 id="userName">Usuario</h2>
                    <p id="userEmail">-</p>
                </div>
            </div>
            <button class="logout-btn" onclick="handleLogout()">Cerrar sesi√≥n</button>
        </div>

        <div class="promo-banner hidden" id="promoBanner">
            <h3>üöÄ ¬°Empieza ahora!</h3>
            <p>Explora nuestras aplicaciones profesionales</p>
            <a href="store.html" class="btn btn-primary" style="max-width: 200px; margin: 0 auto;">Ver aplicaciones</a>
        </div>

        <div class="section">
            <h3 class="section-title">üîë Mis Licencias</h3>
            <div id="licensesContainer"><div class="empty-state"><div class="spinner"></div><p style="margin-top:1rem">Cargando...</p></div></div>
        </div>

        <div class="section hidden" id="ordersSection">
            <h3 class="section-title">üìã Historial de Compras</h3>
            <div id="ordersContainer"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://admin.visionui.app';
        
        async function checkSession() {
            const token = localStorage.getItem('visionui_session');
            if (!token) { showAuth(); return; }
            try {
                const response = await fetch(`${API_BASE}/api/user/me`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (response.ok) { showDashboard(await response.json()); }
                else { localStorage.removeItem('visionui_session'); showAuth(); }
            } catch (e) { console.error(e); showAuth(); }
        }

        function showAuth() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('authView').classList.remove('hidden');
            document.getElementById('dashboardView').classList.add('hidden');
        }

        function showDashboard(data) {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('authView').classList.add('hidden');
            document.getElementById('dashboardView').classList.remove('hidden');
            document.getElementById('userName').textContent = data.name || 'Usuario';
            document.getElementById('userEmail').textContent = data.email;
            renderLicenses(data.licenses || []);
            if (data.orders?.length > 0) { document.getElementById('ordersSection').classList.remove('hidden'); renderOrders(data.orders); }
            if (!data.licenses || data.licenses.length === 0) { document.getElementById('promoBanner').classList.remove('hidden'); }
        }

        function switchTab(tab) {
            document.getElementById('alertBox').classList.remove('show');
            document.getElementById('tabLogin').classList.toggle('active', tab === 'login');
            document.getElementById('tabRegister').classList.toggle('active', tab === 'register');
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
        }

        function showAlert(msg, type = 'error') {
            const el = document.getElementById('alertBox');
            el.textContent = msg;
            el.className = `alert alert-${type} show`;
        }

        function renderLicenses(licenses) {
            const container = document.getElementById('licensesContainer');
            if (!licenses?.length) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì¶</div><p>No tienes licencias activas a√∫n</p><a href="store.html" class="btn btn-primary" style="max-width:200px;margin:0 auto">Explorar aplicaciones</a></div>`;
                return;
            }
            const email = document.getElementById('userEmail').textContent;
            container.innerHTML = licenses.map(l => {
                const expired = l.expires_at && new Date(l.expires_at) < new Date();
                const cls = expired || l.status !== 'active' ? 'expired' : 'active';
                const txt = expired ? 'Expirada' : (l.status === 'active' ? 'Activa' : l.status);
                return `<div class="license-card"><div class="license-header"><span class="license-app">${l.app||'VisionUI'}</span><span class="license-status ${cls}">${txt}</span></div><div class="license-details"><div class="license-detail"><div class="license-detail-label">License Key</div><div class="license-detail-value">${l.license_key}</div></div><div class="license-detail"><div class="license-detail-label">V√°lida hasta</div><div class="license-detail-value">${l.expires_at ? new Date(l.expires_at).toLocaleDateString() : 'Sin expiraci√≥n'}</div></div><div class="license-detail"><div class="license-detail-label">Activada</div><div class="license-detail-value">${new Date(l.created_at).toLocaleDateString()}</div></div></div>${cls==='active'?`<div class="license-actions"><a href="${API_BASE}/api/download/${encodeURIComponent(l.app||'VisionUI')}?email=${encodeURIComponent(email)}&key=${encodeURIComponent(l.license_key)}" class="download-btn" target="_blank">‚¨áÔ∏è Descargar</a></div>`:''}</div>`;
            }).join('');
        }

        function renderOrders(orders) {
            document.getElementById('ordersContainer').innerHTML = orders.map(o => `<div class="license-card" style="padding:1rem"><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem"><div><strong>${o.app_name||o.product_name||'VisionUI'}</strong> <span style="color:var(--text-muted);font-size:0.85rem">${o.variant_name||''}</span></div><div style="text-align:right"><div style="font-weight:600">${o.currency||'USD'} ${((o.amount_paid||0)/100).toFixed(2)}</div><div style="color:var(--text-muted);font-size:0.8rem">${new Date(o.created_at).toLocaleDateString()}</div></div></div></div>`).join('');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            btn.disabled = true; btn.textContent = 'Cargando...';
            try {
                const res = await fetch(`${API_BASE}/api/user/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
                const data = await res.json();
                if (data.success && data.token) {
                    localStorage.setItem('visionui_session', data.token);
                    const me = await fetch(`${API_BASE}/api/user/me`, { headers: { 'Authorization': `Bearer ${data.token}` } });
                    if (me.ok) showDashboard(await me.json());
                } else { showAlert(data.error || 'Error al iniciar sesi√≥n'); }
            } catch (err) { showAlert('Error de conexi√≥n'); }
            btn.disabled = false; btn.textContent = 'Iniciar sesi√≥n';
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const password2 = document.getElementById('registerPassword2').value;
            if (password !== password2) { showAlert('Las contrase√±as no coinciden'); return; }
            if (password.length < 6) { showAlert('M√≠nimo 6 caracteres'); return; }
            const btn = document.getElementById('registerBtn');
            btn.disabled = true; btn.textContent = 'Creando...';
            try {
                const res = await fetch(`${API_BASE}/api/user/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password, name: name || undefined }) });
                const data = await res.json();
                if (data.success && data.token) {
                    localStorage.setItem('visionui_session', data.token);
                    const me = await fetch(`${API_BASE}/api/user/me`, { headers: { 'Authorization': `Bearer ${data.token}` } });
                    if (me.ok) showDashboard(await me.json());
                } else { showAlert(data.error || 'Error al crear cuenta'); }
            } catch (err) { showAlert('Error de conexi√≥n'); }
            btn.disabled = false; btn.textContent = 'Crear cuenta';
        }

        async function handleLogout() {
            const token = localStorage.getItem('visionui_session');
            if (token) { try { await fetch(`${API_BASE}/api/user/logout`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); } catch(e){} }
            localStorage.removeItem('visionui_session');
            showAuth();
        }

        checkSession();
    </script>
</body>
</html>
